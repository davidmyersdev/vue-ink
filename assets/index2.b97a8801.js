import{S as t,v as e,h as s,a as i,w as n,Z as r,b as a,T as h,M as o,c as l,s as u,N as p,A as f,X as c}from"./vendor.29a275eb.js";function g(t,e,s,i=0,n=0){null==e&&-1==(e=t.search(/[^\s\u00a0]/))&&(e=t.length);let r=n;for(let a=i;a<e;a++)9==t.charCodeAt(a)?r+=s-r%s:r++;return r}class d{constructor(t,e,s){this.string=t,this.tabSize=e,this.indentUnit=s,this.pos=0,this.start=0,this.lastColumnPos=0,this.lastColumnValue=0}eol(){return this.pos>=this.string.length}sol(){return 0==this.pos}peek(){return this.string.charAt(this.pos)||void 0}next(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)}eat(t){let e,s=this.string.charAt(this.pos);if(e="string"==typeof t?s==t:s&&(t instanceof RegExp?t.test(s):t(s)),e)return++this.pos,s}eatWhile(t){let e=this.pos;for(;this.eat(t););return this.pos>e}eatSpace(){let t=this.pos;for(;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>t}skipToEnd(){this.pos=this.string.length}skipTo(t){let e=this.string.indexOf(t,this.pos);if(e>-1)return this.pos=e,!0}backUp(t){this.pos-=t}column(){return this.lastColumnPos<this.start&&(this.lastColumnValue=g(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue}indentation(){return g(this.string,null,this.tabSize)}match(t,e,s){if("string"==typeof t){let i=t=>s?t.toLowerCase():t;return i(this.string.substr(this.pos,t.length))==i(t)?(!1!==e&&(this.pos+=t.length),!0):null}{let s=this.string.slice(this.pos).match(t);return s&&s.index>0?null:(s&&!1!==e&&(this.pos+=s[0].length),s)}}current(){return this.string.slice(this.start,this.pos)}}function m(t){if("object"!=typeof t)return t;let e={};for(let s in t){let i=t[s];e[s]=i instanceof Array?i.slice():i}return e}class k extends t{constructor(t){let h,o=e(t.languageData),l={token:(u=t).token,blankLine:u.blankLine||(()=>{}),startState:u.startState||(()=>!0),copyState:u.copyState||m,indent:u.indent||(()=>null),languageData:u.languageData||{}};var u;super(o,new class extends s{createParse(t,e,s){return new S(h,t,e,s)}},function(t){let e=i.define({id:y.length,name:"Document",props:[n.add((()=>t))]});return y.push(e),e}(o),[r.of(((t,e)=>this.getIndent(t,e)))]),h=this,this.streamParser=l,this.stateAfter=new a({perNode:!0})}static define(t){return new k(t)}getIndent(t,e){let s=h(t.state),i=s.resolve(e);for(;i&&i.type!=this.topNode;)i=i.parent;if(!i)return null;let n,r,a=P(this,s,0,i.from,e);if(a?(r=a.state,n=a.pos+1):(r=this.streamParser.startState(t.unit),n=0),e-n>1e4)return null;for(;n<e;){let s=t.state.doc.lineAt(n),i=Math.min(e,s.to);if(s.length){let e=new d(s.text,t.state.tabSize,t.unit);for(;e.pos<i-s.from;)w(this.streamParser.token,e,r)}else this.streamParser.blankLine(r,t.unit);if(i==e)break;n=s.to+1}let{text:o}=t.state.doc.lineAt(e);return this.streamParser.indent(r,/^\s*(.*)/.exec(o)[1],t)}get allowsNesting(){return!1}}function P(t,e,s,i,n){let r=s>=i&&s+e.length<=n&&e.prop(t.stateAfter);if(r)return{state:t.streamParser.copyState(r),pos:s+e.length};for(let a=e.children.length-1;a>=0;a--){let r=e.children[a],h=s+e.positions[a],l=r instanceof o&&h<n&&P(t,r,h,i,n);if(l)return l}return null}function b(t,e,s,i,n){if(n&&s<=0&&i>=e.length)return e;n||e.type!=t.topNode||(n=!0);for(let r=e.children.length-1;r>=0;r--){let a,h=e.positions[r]+s,l=e.children[r];if(h<i&&l instanceof o){if(!(a=b(t,l,s-h,i-h,n)))break;return n?new o(e.type,e.children.slice(0,r).concat(a),e.positions.slice(0,r+1),h+a.length):a}}return null}class S{constructor(t,e,s,i){this.lang=t,this.input=e,this.fragments=s,this.ranges=i,this.stoppedAt=null,this.chunks=[],this.chunkPos=[],this.chunk=[],this.chunkReused=void 0,this.rangeIndex=0,this.to=i[i.length-1].to;let n=c.get(),r=i[0].from,{state:a,tree:h}=function(t,e,s,i){for(let n of e){let e,i=n.from+(n.openStart?25:0),r=n.to-(n.openEnd?25:0),a=i<=s&&r>s&&P(t,n.tree,0-n.offset,s,r);if(a&&(e=b(t,n.tree,s+n.offset,a.pos+n.offset,!1)))return{state:a.state,tree:e}}return{state:t.streamParser.startState(i?l(i):4),tree:o.empty}}(t,s,r,null==n?void 0:n.state);this.state=a,this.parsedPos=this.chunkStart=r+h.length,h.length&&(this.chunks.push(h),this.chunkPos.push(0)),n&&this.parsedPos<n.viewport.from-1e5&&(this.state=this.lang.streamParser.startState(l(n.state)),n.skipUntilInView(this.parsedPos,n.viewport.from),this.parsedPos=n.viewport.from)}advance(){let t=c.get(),e=null==this.stoppedAt?this.to:this.stoppedAt,s=Math.min(e,this.chunkStart+2048);for(t&&(s=Math.min(s,t.viewport.to));this.parsedPos<s;)this.parseLine(t);return this.chunkStart<this.parsedPos&&this.finishChunk(),this.parsedPos>=e?this.finish():t&&this.parsedPos>t.viewport.to?(t.skipUntilInView(this.parsedPos,e),this.finish()):null}stopAt(t){this.stoppedAt=t}lineAfter(t){let e=this.input.chunk(t);if(this.input.lineChunks)"\n"==e&&(e="");else{let t=e.indexOf("\n");t>-1&&(e=e.slice(0,t))}return t+e.length<=this.to?e:e.slice(0,this.to-t)}nextLine(){let t=this.parsedPos,e=this.lineAfter(t),s=t+e.length;for(let i=this.rangeIndex;;){let t=this.ranges[i].to;if(t>=s)break;if(e=e.slice(0,t-(s-e.length)),i++,i==this.ranges.length)break;let n=this.ranges[i].from,r=this.lineAfter(n);e+=r,s=n+r.length}return{line:e,end:s}}skipGapsTo(t,e,s){for(;;){let i=this.ranges[this.rangeIndex].to,n=t+e;if(s>0?i>n:i>=n)break;e+=this.ranges[++this.rangeIndex].from-i}return e}emitToken(t,e,s,i,n){if(this.ranges.length>1){e+=n=this.skipGapsTo(e,n,1);let t=this.chunk.length;s+=n=this.skipGapsTo(s,n,-1),i+=this.chunk.length-t}return this.chunk.push(t,e,s,i),n}parseLine(t){let{line:e,end:s}=this.nextLine(),i=0,{streamParser:n}=this.lang,r=new d(e,t?t.state.tabSize:4,t?l(t.state):2);if(r.eol())n.blankLine(this.state,r.indentUnit);else for(;!r.eol();){let t=w(n.token,r,this.state);t&&(i=this.emitToken(N(t),this.parsedPos+r.start,this.parsedPos+r.pos,4,i))}this.parsedPos=s,this.parsedPos<this.to&&this.parsedPos++}finishChunk(){let t=o.build({buffer:this.chunk,start:this.chunkStart,length:this.parsedPos-this.chunkStart,nodeSet:A,topID:0,maxBufferLength:2048,reused:this.chunkReused});t=new o(t.type,t.children,t.positions,t.length,[[this.lang.stateAfter,this.lang.streamParser.copyState(this.state)]]),this.chunks.push(t),this.chunkPos.push(this.chunkStart-this.ranges[0].from),this.chunk=[],this.chunkReused=void 0,this.chunkStart=this.parsedPos}finish(){return new o(this.lang.topNode,this.chunks,this.chunkPos,this.parsedPos-this.ranges[0].from).balance()}}function w(t,e,s){e.start=e.pos;for(let i=0;i<10;i++){let i=t(e,s);if(e.pos>e.start)return i}throw new Error("Stream parser failed to advance stream.")}const v=Object.create(null),y=[i.none],A=new p(y),x=[];function N(t){return t?v[t]||(v[t]=function(t){let e=null;for(let i of t.split(".")){let t=f[i];t?"function"==typeof t?e?e=t(e):C(i,`Modifier ${i} used at start of tag`):e?C(i,`Tag ${i} used as modifier`):e=t:C(i,`Unknown highlighting tag ${i}`)}if(!e)return 0;let s=t.replace(/ /g,"_"),n=i.define({id:y.length,name:s,props:[u({[s]:e})]});return y.push(n),n.id}(t)):0}for(let[L,I]of[["variable","variableName"],["variable-2","variableName.special"],["string-2","string.special"],["def","variableName.definition"],["tag","typeName"],["attribute","propertyName"],["type","typeName"],["builtin","variableName.standard"],["qualifier","modifier"],["error","invalid"],["header","heading"],["property","propertyName"]])v[L]=N(I);function C(t,e){x.indexOf(t)>-1||(x.push(t),console.warn(e))}export{k as StreamLanguage,d as StringStream};
